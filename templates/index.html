<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Analysis with Gemini</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: auto; }
        textarea { width: 100%; min-height: 100px; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #results { margin-top: 20px; padding: 15px; border: 1px solid #eee; background-color: #f9f9f9; border-radius: 4px; white-space: pre-wrap; /* Preserve whitespace and line breaks */ }
        .error { color: red; font-weight: bold; }
        .loading { font-style: italic; color: #555; }
    </style>
</head>
<body>

    <h1>Analyze Call Transcripts</h1>
    <p>Enter your analysis request below (e.g., "What patterns lead to closed deals?"). The app will fetch transcripts and outcomes from Airtable and ask Gemini to analyze them.</p>

    <form id="analysis-form">
        <textarea id="prompt-input" placeholder="Enter your analysis request here..."></textarea>
        
        <div style="display: flex; gap: 15px; margin-bottom: 10px; flex-wrap: wrap;">
          <div>
            <label for="transcript-count">Number of most recent:</label><br>
            <input type="number" id="transcript-count" name="transcript-count" min="0" value="16" placeholder="(0=All)" title="Number of most recent transcripts to analyze (0 or blank for All)" style="width: 80px;">
            <small>(0=All)</small>
          </div>
          <div>
            <label for="filter-outcome">Filter by Call Outcome:</label><br>
            <select id="filter-outcome" name="filter-outcome" style="width: 160px;">
              <option value="">-- Any Outcome --</option>
              <option value="1 Call Close">1 Call Close</option>
              <option value="Follow Up Close">Follow Up Close</option>
              <option value="Follow Up Set">Follow Up Set</option>
              <option value="No Set">No Set</option>
              <option value="Attempted Set">Attempted Set</option>
              <option value="Set No Close">Set No Close</option>
              <option value="Set Still Working">Set Still Working</option>
            </select>
          </div>
           <div>
            <label for="filter-rep">Filter by Sales Rep(s):</label><br>
            <select id="filter-rep" name="filter-rep" multiple size="3" style="width: 160px; vertical-align: top;">
              <option value="Patrick">Patrick</option>
              <option value="Tracey">Tracey</option>
              <option value="Jim">Jim</option>
              <option value="Keith">Keith</option>
              <option value="Abhishek">Abhishek</option>
            </select>
          </div>
           <div>
            <label for="filter-call-type">Filter by Call Type:</label><br>
            <select id="filter-call-type" name="filter-call-type" style="width: 160px;">
              <option value="">-- Any Type --</option>
              <option value="Setter">Setter</option>
              <option value="Closer">Closer</option>
            </select>
          </div>
        </div>
        <small style="display: block; margin-bottom: 10px;">Filters apply *before* selecting the most recent number. Warning: 'All' can be slow/expensive.</small>

        <button type="submit">Analyze</button>
    </form>

    <div style="display: flex; align-items: center; justify-content: space-between;">
      <h2>Results:</h2>
      <button id="copy-button" style="display: none; margin-left: 10px;">Copy</button>
    </div>
    <div id="results">
        Enter your request above and click Analyze.
    </div>

    <script>
        const form = document.getElementById('analysis-form');
        const input = document.getElementById('prompt-input');
        const countInput = document.getElementById('transcript-count');
        const outcomeFilterSelect = document.getElementById('filter-outcome'); // Get outcome select
        const repFilterSelect = document.getElementById('filter-rep');       // Get rep MULTI-select
        const callTypeFilterSelect = document.getElementById('filter-call-type'); // Get call type select
        const resultsDiv = document.getElementById('results');
        const copyButton = document.getElementById('copy-button');

        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission
            const userPrompt = input.value.trim();
            let transcriptCount = parseInt(countInput.value, 10);
            const outcomeFilter = outcomeFilterSelect.value; // Read outcome select value
            
            // Get selected reps from multi-select
            const selectedRepOptions = Array.from(repFilterSelect.selectedOptions);
            const repFilters = selectedRepOptions.map(option => option.value);

            const callTypeFilter = callTypeFilterSelect.value; // Read call type select value

            // Treat NaN (from blank input) or negative numbers as 0 (meaning 'All' for count)
            if (isNaN(transcriptCount) || transcriptCount < 0) {
                transcriptCount = 0;
            }

            // Hide copy button on new submission
            copyButton.style.display = 'none';
            copyButton.textContent = 'Copy'; // Reset button text

            if (!userPrompt) {
                resultsDiv.innerHTML = '<p class="error">Please enter an analysis request.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p class="loading">Fetching data and analyzing with Gemini... Please wait.</p>';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        prompt: userPrompt,
                        transcript_count: transcriptCount, 
                        filter_outcome: outcomeFilter, // Send outcome select value
                        filter_rep: repFilters,        // Send rep select values (now an ARRAY)
                        filter_call_type: callTypeFilter // Send call type select value
                    }),
                });

                const data = await response.json();

                if (!response.ok) {
                    // Display error message from backend
                    resultsDiv.innerHTML = `<p class="error">Error: ${data.error || response.statusText}</p>`;
                    copyButton.style.display = 'none'; // Ensure hidden on error
                } else {
                    // Display analysis result
                    resultsDiv.textContent = data.analysis; // Use textContent to avoid potential HTML injection
                    copyButton.style.display = 'inline-block'; // Show copy button
                }
            } catch (error) {
                console.error("Fetch error:", error);
                resultsDiv.innerHTML = `<p class="error">An error occurred while communicating with the server: ${error.message}</p>`;
                copyButton.style.display = 'none'; // Ensure hidden on error
            }
        });

        // Add event listener for the copy button
        copyButton.addEventListener('click', async () => {
            const textToCopy = resultsDiv.textContent;
            if (!textToCopy || resultsDiv.querySelector('.error, .loading')) {
                // Don't copy if there's no result or if it's an error/loading message
                return; 
            }
            try {
                await navigator.clipboard.writeText(textToCopy);
                copyButton.textContent = 'Copied!';
                // Optionally, reset the button text after a short delay
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                }, 2000); // Reset after 2 seconds
            } catch (err) {
                console.error('Failed to copy text: ', err);
                copyButton.textContent = 'Failed'; // Indicate failure
                 setTimeout(() => {
                    copyButton.textContent = 'Copy';
                }, 2000);
            }
        });
    </script>

</body>
</html> 